<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>CLI-Spotify-Downloader Web</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/download_style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/download_style.css') }}" />
</head>
<body>
    <div class="bar" id="top-bar">
      <h1 id="Title">
        <a href="{{ url_for('index') }}" id="Title-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M320 72C183 72 72 183 72 320C72 457 183 568 320 568C457 568 568 457 568 320C568 183 457 72 320 72zM420.7 436.9C416.5 436.9 413.9 435.6 410 433.3C347.6 395.7 275 394.1 203.3 408.8C199.4 409.8 194.3 411.4 191.4 411.4C181.7 411.4 175.6 403.7 175.6 395.6C175.6 385.3 181.7 380.4 189.2 378.8C271.1 360.7 354.8 362.3 426.2 405C432.3 408.9 435.9 412.4 435.9 421.5C435.9 430.6 428.8 436.9 420.7 436.9zM447.6 371.3C442.4 371.3 438.9 369 435.3 367.1C372.8 330.1 279.6 315.2 196.7 337.7C191.9 339 189.3 340.3 184.8 340.3C174.1 340.3 165.4 331.6 165.4 320.9C165.4 310.2 170.6 303.1 180.9 300.2C208.7 292.4 237.1 286.6 278.7 286.6C343.6 286.6 406.3 302.7 455.7 332.1C463.8 336.9 467 343.1 467 351.8C466.9 362.6 458.5 371.3 447.6 371.3zM478.6 295.1C473.4 295.1 470.2 293.8 465.7 291.2C394.5 248.7 267.2 238.5 184.8 261.5C181.2 262.5 176.7 264.1 171.9 264.1C158.7 264.1 148.6 253.8 148.6 240.5C148.6 226.9 157 219.2 166 216.6C201.2 206.3 240.6 201.4 283.5 201.4C356.5 201.4 433 216.6 488.9 249.2C496.7 253.7 501.8 259.9 501.8 271.8C501.8 285.4 490.8 295.1 478.6 295.1z"/></svg>
        </a> Downloader
      </h1>
    </div>
    <div id="download-container">
      <h2 id="download_text">Download Output</h2>
    </div>
    <div class="terminal-wrapper">
    <div id="terminal"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/terminal_style.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/terminal_style.css') }}" />

    <script>
      const term = new Terminal({
        cursorBlink: false,
        disableStdin: true,
        cursorStyle: 'block',
        cols: 80
      });
      term.open(document.getElementById('terminal'));

      const socket = io();

      // Fetch song info JSON from your backend API endpoint
      async function fetchSongInfoAndStartDownload() {
        try {
          const response = await fetch('/api/song_info');
          if (!response.ok) {
            throw new Error('Could not fetch song info');
          }
          const songInfo = await response.json();

          if (songInfo.track_url) {
            socket.emit('start_download', {
              track_url: songInfo.track_url,
              download_path: songInfo.download_path,
              song: songInfo.song,
              album: songInfo.album,
              artist: songInfo.artist
            });
          } else {
            console.error('Track URL missing in song info');
          }
        } catch (error) {
          console.error('Error fetching song info:', error);
        }
      }

      socket.on('connect', () => {
        fetchSongInfoAndStartDownload();
      });

      socket.on('stdout', function(msg) {
        console.log("Got stdout:", msg.data);
        term.write(msg.data);
      });

      socket.on('download_complete', function(msg) {
        addFlashMessage('message', msg.message);
      });

      socket.on('download_error', function(msg) {
        addFlashMessage('error', msg.message);
      });

      function addFlashMessage(category, message) {
        const messagesDiv = document.getElementById('messages');
        const li = document.createElement('li');
        li.className = category;
        li.textContent = message;

        let ul = messagesDiv.querySelector('ul');
        if (!ul) {
          ul = document.createElement('ul');
          messagesDiv.appendChild(ul);
        }
        ul.appendChild(li);
      }
    </script>

  </div>

  <div id="messages">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul>
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
    </div>
    
</body>

